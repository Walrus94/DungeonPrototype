name: Update Deployment Workflow

on:
  create:
    branches:
      - '**' # Trigger on any new branch creation
  delete:
    branches:
      - '**' # Trigger on any branch deletion
  workflow_dispatch: # Allows manual updates as a fallback

jobs:
  update-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Branch List
        id: fetch_branches
        run: |
          echo "Fetching branches..."
          BRANCHES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/branches | jq -r '.[].name')

          # Save branch list to environment variable
          echo "branches=$BRANCHES" >> $GITHUB_ENV

      - name: Update Workflow File
        run: |
          # Generate the list of branches in YAML format
          BRANCH_OPTIONS=$(echo ${{ env.branches }} | awk '{printf "- %s\n", $0}')

          # Update the deployment workflow YAML
          sed -i '/# BEGIN BRANCH LIST/,/# END BRANCH LIST/c\
          # BEGIN BRANCH LIST\n          options:\n'"$BRANCH_OPTIONS"'          # END BRANCH LIST' \
            .github/workflows/deploy-to-test.yml

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/test-env-deployment.yml
          git commit -m "Update branch dropdown menu after branch ${GITHUB_REF_TYPE}: ${GITHUB_REF_NAME}"
          git push
